******************************
******** KQL Workshop ********
******************************
******* Version: 0.0.1 *******
******************************
***** -By: Matt Scheurer *****
******************************
******* x.com: @c3rkah *******
******************************

******************************
******** Introduction ********
******************************

What is the Kusto Query Language (KQL)?

The Kusto Query Language (KQL) is a powerful query language for exploring and analyzing data in a variety of Microsoft platforms. Think of KQL being useful for retrieving and analyzing log data similar to how the Structured Query Language (SQL) is useful for working with databases and their contents. KQL is the defacto query language used throughout Microsoft Azure, the Microsoft Sentinel Security Information and Event Management (SIEM) platform, and a variety of Microsoft Defender security solutions to name a few.

NOTE: Microsoft Azure Resource Graph, Microsoft Defender for Endpoints (MDE) "Advanced Hunting" and others lack support for some tables, sources, and render operators available in native KQL.


******************************
******** Exercise 00: ********
******************************

Getting Started
---------------

We'll leverage the free "Kusto Detective Agency" training platform environment for our KQL workshop lab exercises. For the purposes of this training, we will refer to the top window pane as the "query" window, and the bottom pane as the "results" window.

Steps:

1. Go to the web site, https://detective.kusto.io/
2. Click on "Go to Inbox".
3. Click on the "Onboarding" message.
4. Click on the "Run" button to launch the "Azure Data Explorer".
5. Click on the "Homoe" icon.
6. Click on the "Get Data" icon to note the variety of "data sources" which are connectable and importable to the Azure Data Explorer.
7. Click on the "Cancel" button to exit the Get Data settings and return to the Home screen.
8. Click on one of the "Query" buttons to open the KQL screen.
9. Note that the KQL Query window supports multiple renamable tabs for multiple active queries.
10. Expand the "Security Logs" database to review available tables in the example data.


******************************
******** Exercise 01: ********
******************************

KQL Syntax Basics
-----------------

Having a foundational knowledge of another query language such as the Structured Query Language (SQL) helps with learning KQL faster, but is not required. There are vast differences between the operators and syntax between both KQL and SQL. A KQL query typically starts with a data source and uses operators connected by the pipe (|) character.

Pro Tip: Always use the at sign "@" before the " in strings to account for spacing, non-standard alpa-numeric characters, etc.
 
Restrict results by rendered output columns
-------------------------------------------

"project" to specify the output fields
| project column1, column2, column3

NOTE: Spaces between the columns is optional, but might help with readability.

Restricting results by operators
--------------------------------

- "limit" vs "take" vs "top"
-- "limit" and "take" essentially work the same
- "take" retrieves a random subset (no ordering) of results
- "top" returns the most (or least) prevalent criteria results
-- “top by” is the highest number of results based on the criteria "asc" or "desc"

Restricting results by time
---------------------------

Examples:
| sort by Timestamp
| top 100 by Timestamp desc
| where Timestamp > ago(1d)
| where Timestamp >= datetime(2025-06-23) and Timestamp < datetime(2025-06-24)
| search in (Thing1,Thing2,Thing3,) and Timestamp between (ago(1h) .. now())

Summarize results
-----------------

| summarize count() by [COLUMN-NAME]

Case Sensitivity
----------------

KQL hash searches are typically case sensitive and require lower case alphebetic characters. Annoyingly, PowerShell's built-in Hashing cmdlet returns alphabetic hash values in upper-case by default. Use the following in PowerShell to convert returned hash values to lower-case so KQL finds them:
(Get-FileHash -Algorithm SHA256 "[FILEPATH]").Hash.ToLower()

MISC
----

Semicolon “;” in KQL
- Defines multiple queries in one
- Create usable named expressions ("like" functions or "let" statements)
- Chain operations that depend on earlier definitions


******************************
******** Exercise 02: ********
******************************

GIGO
----

"GIGO" is an acronym for the concept of "Garbage In, Garbage Out".

SIEM platforms and query languages can only provide results as good as the quality of the logs and data hosted in them. There are a variety of issues plaguing SIEM logs. Common problems are log configuration issues, health and uptime failures, not ingesting data properly, data indexing incorrectly, data and/or fields not parsing correctly, and more.

Steps, Part 1:

1. Clear the KQL window or begin with a new tab.
2. Navigate down to the "SecurityLogs" database and expand the list of tables.
3. Double click on the "Email" table to add it to the KQL window.
4. Delete the second line, especially the pipe (|) symbol.
5. Verify that there is only one line with the following query:
   database('SecurityLogs').table('Email')
6. Click the "Run" button giving the Azure Data Explorer time to complete the query.

At first glance, it appears that we have a good set of data. However, upon further inspection we see the data column names do not match the expected data types outside of the "event_time" appearing to be a valid timestamp. Unfortunately, these data type mismatches are a somewhat common issue observed within SIEM platforms regardless of the vendor platform.

"event_time" is as expected, but is the only such field which does.
"sender": appears to be our inbound mail server name.
"reply_to": appears to be the IP address belonging to the sender's email transport gateway.
"recipient": appears to be a browser (webmail?) user agent string value.
"subject": appears to be the username of the email message recipient.
"accepted": appears to be a null value "," from the CSV data and an unused field.
"link": appears to be a hexadecimal Message ID number. 

Conclusions: We can adjust our queries for the actual information we want or avoid using the "Email" table completely. However, we can fix our column names on the fly using KQL.

Steps, Part 2:

1. Add the following code (without the double quotes) to the second line: "| project-rename server=sender,src_ip=reply_to,user_agent=recipient,username=subject,message_id=link"
2. Add the following code (without the double quotes) to the third line: "| project-away accepted" server=sender,src_ip=reply_to,user_agent=recipient,username=subject,message_id=link"
3. Review and ensure that the full KQL query appears as follows:

   database('SecurityLogs').table('Email') 
   | project-rename server=sender,src_ip=reply_to,user_agent=recipient,username=subject,message_id=link
   | project-away accepted

4. Click on the "Run" button.

This returns more appropriately named columns in our KQL results. The "project-rename" operator lets us rename one or more columns to suit our data or personal preferences. The "project-away" lets us hide a column(s) from the returned query results.

NOTES: Unlike many operators KQL does not like dashes in the column names, which is why underscores were used instead. Column names must be unique, which we chose "username" instead of "recipient", since the "recipient" column name already existed in our database table.


******************************
******** Exercise 03: ********
******************************




******************************
************ Misc ************
******************************

Further Learning
----------------

We've covered a lot of ground in these lab exercises, but barely scratched the surface on the full capabilities of KQL. Here are some additional resources to continue learning more about KQL.

KQL quick reference
https://learn.microsoft.com/en-us/kusto/query/kql-quick-reference?view=azure-data-explorer&preserve-view=true

Microsoft "Hunting Queries"
https://github.com/microsoft/Microsoft-365-Defender-Hunting-Queries
https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/Microsoft%20365%20Defender

Microsoft Sentinel Ninja Training
https://aka.ms/SentinelNinjaTraining
